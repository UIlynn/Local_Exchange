<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지역화폐 가맹점 현황</title>

    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- bootstrap -->
    <script src="./static/jquery/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="./static/popper/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="./static/bootstrap/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./static/bootstrap/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- kakao map -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=96f98198823e1b22e7b29bb2e9afc824&libraries=services"></script>

    <!-- custom -->
    <!-- style.css -->
    <link rel="stylesheet" href="./static/style.css" class="css">
</head>

<body>
    <section id="header" class="container-fluid text-center">
                <span>지역 화폐 가맹점 검색 사이트</span>  
    </section>

    <section id="top" class="container-fluid">
        <div class="row inner">
            <div class="col-sm-12 col-md-8 offset-md-2 input-group">
                <input type="text" class="form-control" placeholder="검색 장소 입력" aria-label="Username"
                    aria-describedby="basic-addon1" id="textSearch">

                <button class="btn btn-outline-secondary" type="button" id="btnSearch">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-search" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M10.442 10.442a1 1 0 0 1 1.415 0l3.85 3.85a1 1 0 0 1-1.414 1.415l-3.85-3.85a1 1 0 0 1 0-1.415z" />
                        <path fill-rule="evenodd"
                            d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </section>

    <section id="map" class="container-fluid">
        <div class="row inner">
            <div id="mapContainer"></div>

            </div>
        </div>
    </section>

    <!-- 카테고리 선택 큰 화면 -->
    <section id="categorys" class="container-fluid">
        <div class="row inner">
            <button type="button" class="btn btn-outline-primary col-sm-2">식당</button>
            <button type="button" class="btn btn-outline-primary col-sm-2">카페</button>
            <button type="button" class="btn btn-outline-primary col-sm-2">마트</button>
            <button type="button" class="btn btn-outline-primary col-sm-2">병원</button>
            <button type="button" class="btn btn-outline-primary col-sm-2">의류</button>
            <button type="button" class="btn btn-outline-primary col-sm-2">미용</button>
        </div>
    </section>

    <!-- 카테고리 선택 작은 화면 -->
    <section id="categorys_sm" class="container-fluid">
        <div class="btn-group btn-block">
            <button type="button" class="btn btn-outline-primary btn-lg  dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              카테고리 선택
            </button>
            <div class="dropdown-menu btn-block">
              <a class="dropdown-item" href="#">식당</a>
              <a class="dropdown-item" href="#">카페</a>
              <a class="dropdown-item" href="#">마트</a>
              <a class="dropdown-item" href="#">병원</a>
              <a class="dropdown-item" href="#">의류</a>
              <a class="dropdown-item" href="#">미용</a>
            </div>
          </div>
    </section>
  
  <!-- Modal -->
  <div class="modal fade" id="localSelectModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="localSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="localSelectModalLabel">검색 : 신촌역</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="localSelectModalBody">
            <!-- 내부 코드 들어가는 장소 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Understood</button>
        </div>
      </div>
    </div>
  </div>

</body>
    <script>
        // 주요 요소
        const btnSearch = document.querySelector('#btnSearch');
        const textSearch = document.querySelector('#textSearch');
        const mapContainer = document.querySelector('#mapContainer')
        const categorysBtn = document.querySelectorAll('#categorys button')
        const categorysDropdown = document.querySelectorAll('#categorys_sm .dropdown-item')
        const localSelectModalTitle = document.querySelector('#localSelectModalLabel')
        const localSelectModalBody = document.querySelector('#localSelectModalBody')
        

        // gps 현위치로 이동 함수
        function getLocation() {
            if (navigator.geolocation) { // GPS를 지원하면
                navigator.geolocation.getCurrentPosition(({ coords: { latitude, longitude } }) => {
                    console.log(latitude, longitude);
                    // 이동할 위도 경도 위치를 생성합니다 
                    const moveLatLon = new kakao.maps.LatLng(latitude, longitude);
                    map.panTo(moveLatLon);
                })
            } else {
                alert('GPS를 지원하지 않습니다');
            }
        }


        // 초기 맵 설정
        mapOption = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };  

        
        // kakao map 객체를 생성합니다(그리기)
        let map = new kakao.maps.Map(mapContainer, mapOption); 
        // 장소 검색 객체를 생성합니다
        let ps = new kakao.maps.services.Places();  


        // 카테고리 선택시 수행
        function selectCategory(event){
            // console.dir(event.target);
            console.log('>>>selectCategory : ', event.target.innerText);
        };

        // 카테고리 버튼들에게 이벤트 추가
        function addEventCategorys(){
            // categorys 이벤트 추가
            categorysBtn.forEach(element => {
               // console.log(element); 
               element.addEventListener('click',selectCategory);
            });

            // categorys_sm 에 이벤트 추가
            categorysDropdown.forEach(element =>{
                // console.log(element);
                element.addEventListener('click',selectCategory);
            });
        };


        // 지도 이동 함수
        function panTo() {
            const [lng, lat] = [event.target.getAttribute('x'), event.target.getAttribute('y')];
            console.log(lat,lng);
            // 이동할 위도 경도 위치를 생성합니다 
            const moveLatLon = new kakao.maps.LatLng(lat, lng);
            
            // 지도 중심을 부드럽게 이동시킵니다
            // 만약 이동할 거리가 지도 화면보다 크면 부드러운 효과 없이 이동합니다
            map.panTo(moveLatLon);            
        }        


        // 지역 검색 완료 시 콜백 함수
        function placesSearchCB (response, status, pagination) {
            console.dir(response);
            if (status === kakao.maps.services.Status.OK) {
                localSelectModalBody.innerHTML="";
                
                // 장소 선택 요소 만들기
                response.forEach(element =>{
                    const {id, place_name, address_name, x, y} = element;
                    const a = document.createElement("a");
                    a.classList.add('dropdown-item');
                    a.setAttribute('localId',`${id}`);
                    a.setAttribute('x', x);
                    a.setAttribute('y', y);
                    a.innerHTML=`${place_name} : ${address_name}`
                    a.addEventListener('click', panTo);
                    localSelectModalBody.appendChild(a); 
                });
            } 
        }


        // 지역 검색 함수
        function searchArea(){
            console.log(">>> searchArea : ", textSearch.value);
            let keyword = textSearch.value;

            // 유효성 검사
            if (!keyword.replace(/^\s+|\s+$/g, '')) {
                alert('검색 지역을 입력해주세요!');
                return false;
            }

            // 키워드로 장소를 검색합니다
            ps.keywordSearch(textSearch.value, placesSearchCB); 

            // modal open
            $("#localSelectModal").modal();
            
        };

        
        

        // 초기화 함수
        function init(){
            // 검색 버튼 이벤트 추가        
            btnSearch.addEventListener('click', searchArea);

            // 카테고리 버튼들에게 이벤트 추가
            addEventCategorys();

            // gps 권한 받기 및 현위치로 이동
            getLocation();
      
        };

        init();

   

        

    </script>
    
</html>